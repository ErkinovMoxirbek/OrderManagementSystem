<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Chat Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Admin Chat Panel</h4>
                </div>
                <div class="card-body">
                    <div id="loginForm">
                        <input type="email" id="email" class="form-control mb-2" placeholder="Email">
                        <input type="password" id="password" class="form-control mb-2" placeholder="Password">
                        <button class="btn btn-primary w-100" id="loginBtn">Login</button>
                    </div>

                    <div id="chatPanel" style="display:none;">
                        <select id="roomSelect" class="form-select mb-3"></select>
                        <div class="border p-3 mb-3 bg-light" style="height:300px; overflow-y:auto;" id="messages"></div>
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control">
                            <button class="btn btn-primary" id="sendBtn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

<script>
    let stompClient;
    let jwt;
    let currentRoom;

    document.getElementById('loginBtn').addEventListener('click', () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        axios.post('/api/auth/login', {email, password})
            .then(res => {
                jwt = res.data.token;
                loadRooms();
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('chatPanel').style.display = 'block';
            }).catch(err => alert("Login error"));
    });

    function loadRooms() {
        axios.get('/api/chat/rooms', {
            headers: { Authorization: `Bearer ${jwt}` }
        }).then(res => {
            const select = document.getElementById('roomSelect');
            select.innerHTML = "";
            res.data.forEach(room => {
                const opt = document.createElement('option');
                opt.value = room;
                opt.textContent = room;
                select.appendChild(opt);
            });
            select.addEventListener('change', () => connectRoom(select.value));
            connectRoom(select.value);
        });
    }

    function connectRoom(roomId) {
        currentRoom = roomId;
        if (stompClient) stompClient.disconnect();

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({Authorization: `Bearer ${jwt}`}, () => {
            stompClient.subscribe(`/topic/${roomId}`, msg => {
                const msgObj = JSON.parse(msg.body);
                const div = document.createElement('div');
                div.className = 'p-2 bg-secondary text-white rounded mb-1';
                div.textContent = `${msgObj.sender}: ${msgObj.content}`;
                document.getElementById('messages').appendChild(div);
            });
        });
    }

    document.getElementById('sendBtn').addEventListener('click', () => {
        const content = document.getElementById('messageInput').value.trim();
        if (!content) return;

        stompClient.send(`/app/chat/${currentRoom}`, {}, JSON.stringify({
            sender: "ADMIN",
            content: content,
            roomId: currentRoom
        }));
        document.getElementById('messageInput').value = '';
    });
</script>
</body>
</html>
